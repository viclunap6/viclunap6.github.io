<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Luna Castro & Asociados</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="dashboard.css" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class="text-gray-200">
        <div class="flex h-screen bg-gray-900">
            <aside
                id="sidebar-panel"
                class="w-64 bg-gray-950/50 border-r border-gray-700/50 p-6 flex-col hidden lg:flex"
            >
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-white mb-4">
                        Navegación
                    </h2>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="sidebar-link">Inicio</a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link">Clientes</a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link">Casos</a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link">Reportes</a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link">Configuración</a>
                        </li>
                    </ul>
                </div>
            </aside>

            <div class="flex-1 flex flex-col overflow-hidden">
                <header
                    class="bg-gray-900 border-b border-gray-700/50 w-full z-10"
                >
                    <div
                        class="px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16"
                    >
                        <div class="flex items-center justify-center w-full">
                            <a href="index.html" class="flex items-center">
                                <img
                                    src="images/lhalogo.jpg"
                                    alt="Logotipo"
                                    class="h-8 w-auto rounded-md"
                                />
                                <span class="ml-3 font-semibold text-white"
                                    >Luna Castro & Asociados</span
                                >
                            </a>
                        </div>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto">
                    <div class="p-4 sm:p-6 lg:p-8">
                        <div
                            class="bg-gray-800/20 p-6 rounded-xl border border-gray-700/30 mb-8"
                        >
                            <h2 class="text-lg font-semibold mb-4">
                                Áreas de Soporte y Estrategia
                            </h2>
                            <div
                                id="areas-fijas-container"
                                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"
                            ></div>
                        </div>
                        <div
                            class="bg-gray-800/20 p-6 rounded-xl border border-gray-700/30"
                        >
                            <h2 class="text-lg font-semibold mb-4">
                                Equipos Operativos
                            </h2>
                            <div
                                id="equipos-container"
                                class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"
                            ></div>
                        </div>
                    </div>
                    <footer class="site-footer">
                        <div class="footer-grid">
                            <div class="footer-column">
                                <h4>Luna Castro, Herrera & Asociados</h4>
                                <p>
                                    Firma legal dedicada a la prestación de
                                    servicios jurídicos de alta especialización.
                                </p>
                            </div>
                            <div class="footer-column">
                                <h4>Navegación</h4>
                                <ul>
                                    <li>
                                        <a href="index.html#servicios"
                                            >Áreas de Práctica</a
                                        >
                                    </li>
                                    <li>
                                        <a href="index.html">Quiénes Somos</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="footer-column">
                                <h4>Legal</h4>
                                <ul>
                                    <li>
                                        <a href="#">Aviso de Privacidad</a>
                                    </li>
                                    <li>
                                        <a href="#">Términos y Condiciones</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="footer-column">
                                <h4>Contacto</h4>
                                <p>
                                    Av. Álvaro Obregón 12 quinto piso<br />
                                    Colonia Roma Norte, Ciudad de México<br />
                                    <a href="mailto:contacto@lcha.com"
                                        >contacto@lcha.com</a
                                    ><br />
                                    T: +52 55 1234 5678
                                </p>
                            </div>
                        </div>
                        <div class="footer-bottom">
                            <p>
                                © 2025 Luna Castro, Herrera & Asociados, S.C.
                                Todos los derechos reservados.
                            </p>
                        </div>
                    </footer>
                </main>
            </div>
        </div>

        <div
            id="modal-container"
            class="fixed inset-0 z-50 flex items-center justify-center hidden"
        >
            <div
                id="modal-backdrop"
                class="absolute inset-0 bg-black/70 opacity-0"
            ></div>
            <div
                id="modal-panel"
                class="relative bg-gray-800 border border-gray-700 rounded-2xl shadow-xl w-full max-w-lg m-4 transform scale-95 opacity-0"
            >
                <div id="modal-content" class="p-6"></div>
            </div>
        </div>

        <script>
            let solicitudesAyuda = [];
            let nuevosAsuntos = [];
            let costosFijos = [{ nombre: "Renta y Servicios", monto: 60000 }];
            const BONO_POR_ASUNTO = 250;

            const firma = {
                personalFijo: [
                    {
                        id: "admin",
                        rol: "_A. Administración",
                        sueldoBase: 8000,
                        maxIncentivo: 4000,
                        tipoIncentivo: "kpi_clientes",
                        kpiLabel: "% Clientes Pagando",
                    },
                    {
                        id: "sup",
                        rol: "_B. Supervisión",
                        sueldoBase: 16000,
                        incentivoPct: 0.2,
                        tipoIncentivo: "utilidad_global",
                        kpiLabel: "% Cumplimiento",
                    },
                    {
                        id: "ventas",
                        rol: "_C. Ventas",
                        sueldoBase: 8000,
                        incentivoPct: 0.1,
                        tipoIncentivo: "ingresos_globales",
                        kpiLabel: "# Nuevos Asuntos",
                    },
                    {
                        id: "dir",
                        rol: "_D. Dirección",
                        sueldoBase: 20000,
                        incentivoPct: 0.15,
                        tipoIncentivo: "utilidad_global",
                        kpiLabel: "# Solicitudes Asesoría",
                    },
                ],
                equipos: [
                    {
                        id: "unidad-1",
                        nombre: "Equipo Hugo",
                        kpiLabel: "# Asuntos",
                        miembros: [
                            {
                                rol: "Abogado Jefe",
                                nombre: "Hugo",
                                sueldoBase: 8000,
                            },
                            {
                                rol: "Pasante",
                                nombre: "Pasante 1",
                                sueldoBase: 8000,
                            },
                        ],
                        casos: { Civiles: 10, Familiares: 20, Mercantiles: 5 },
                    },
                    {
                        id: "unidad-2",
                        nombre: "Equipo Valeria",
                        kpiLabel: "# Asuntos",
                        miembros: [
                            {
                                rol: "Abogado Jefe",
                                nombre: "Valeria",
                                sueldoBase: 8000,
                            },
                            {
                                rol: "Pasante",
                                nombre: "Pasante 2",
                                sueldoBase: 8000,
                            },
                        ],
                        casos: { Civiles: 15, Familiares: 15, Penales: 3 },
                    },
                    {
                        id: "unidad-3",
                        nombre: "Equipo Emanuel",
                        kpiLabel: "# Asuntos",
                        miembros: [
                            {
                                rol: "Abogado Jefe",
                                nombre: "Emanuel",
                                sueldoBase: 8000,
                            },
                            {
                                rol: "Pasante",
                                nombre: "Pasante 3",
                                sueldoBase: 8000,
                            },
                        ],
                        casos: {
                            Familiares: 15,
                            Mercantiles: 5,
                            Administrativos: 2,
                        },
                    },
                ],
            };

            const formatCurrency = (value) =>
                new Intl.NumberFormat("es-MX", {
                    style: "currency",
                    currency: "MXN",
                }).format(value);
            let currentCalculations = {};

            function crearEquipoCardHTML(unidad) {
                const totalAsuntos = Object.values(unidad.casos).reduce(
                    (a, b) => a + b,
                    0,
                );
                return `<button data-id="${unidad.id}" data-type="equipo" class="modal-trigger bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg text-left card-hover w-full"><h3 class="font-semibold text-white text-base">${unidad.nombre}</h3><p class="text-sm text-gray-400">${unidad.kpiLabel}: <span id="summary-kpi-${unidad.id}" class="font-medium text-white">${totalAsuntos}</span></p></button>`;
            }

            function crearAreaCardHTML(area) {
                let extraInfo = "";
                if (area.id === "dir") {
                    extraInfo = `<p class="text-sm text-gray-400">Costos Fijos: <span id="total-costos-fijos" class="font-medium text-white">$0.00</span></p>`;
                }
                return `<button data-id="${area.id}" data-type="area" class="modal-trigger bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg text-left card-hover w-full"><h3 class="font-semibold text-base text-white">${area.rol}</h3><p class="text-sm text-gray-400">${area.kpiLabel}: <span id="summary-kpi-${area.id}" class="font-medium text-white">0</span></p>${extraInfo}</button>`;
            }

            function calcularTodo() {
                const costoFijoManual = costosFijos.reduce(
                    (acc, c) => acc + c.monto,
                    0,
                );
                const totalClientes =
                    parseFloat(
                        document.getElementById("total-clientes")?.value,
                    ) || 100;
                const clientesPagando =
                    parseFloat(
                        document.getElementById("clientes-pagando")?.value,
                    ) || 85;
                const totalTerminos =
                    parseFloat(
                        document.getElementById("total-terminos")?.value,
                    ) || 200;
                const terminosCumplidos =
                    parseFloat(
                        document.getElementById("terminos-cumplidos")?.value,
                    ) || 190;
                const ingresosGlobales = 180000;

                let bonosEquipos = 0;
                currentCalculations.equipos = {};
                firma.equipos.forEach((u) => {
                    const totalAsuntos = Object.values(u.casos).reduce(
                        (a, b) => a + b,
                        0,
                    );
                    const bonoPorAsuntos = totalAsuntos * BONO_POR_ASUNTO;
                    bonosEquipos += bonoPorAsuntos;
                    currentCalculations.equipos[u.id] = {
                        bonoPorAsuntos,
                        remuneraciones: {},
                    };
                    u.miembros.forEach((m) => {
                        currentCalculations.equipos[u.id].remuneraciones[
                            m.nombre
                        ] = m.sueldoBase;
                    });
                });

                const costoSueldosFijos = firma.personalFijo.reduce(
                    (acc, p) => acc + p.sueldoBase,
                    0,
                );
                const costoTotalEquipos =
                    firma.equipos
                        .flatMap((e) => e.miembros)
                        .reduce((acc, m) => acc + m.sueldoBase, 0) +
                    bonosEquipos;
                const costoTotalFirma =
                    costoFijoManual + costoSueldosFijos + costoTotalEquipos;
                const utilidadNetaGlobal = ingresosGlobales - costoTotalFirma;

                const pctClientes =
                    totalClientes > 0 ? clientesPagando / totalClientes : 0;
                const pctTerminos =
                    totalTerminos > 0
                        ? (terminosCumplidos / totalTerminos) * 100
                        : 0;

                currentCalculations.areas = {};
                firma.personalFijo.forEach((area) => {
                    let incentivo = 0;
                    if (area.tipoIncentivo === "kpi_clientes")
                        incentivo = area.maxIncentivo * pctClientes;
                    else if (area.tipoIncentivo === "ingresos_globales")
                        incentivo =
                            nuevosAsuntos.reduce(
                                (acc, asunto) => acc + asunto.pagoInicial,
                                0,
                            ) * area.incentivoPct;
                    if (area.id === "sup") incentivo = pctTerminos * 40;
                    currentCalculations.areas[area.id] = { incentivo };
                });

                const distDireccion =
                    utilidadNetaGlobal > 0
                        ? utilidadNetaGlobal *
                          firma.personalFijo.find((p) => p.id === "dir")
                              .incentivoPct
                        : 0;
                currentCalculations.areas["dir"].incentivo = distDireccion;

                updateUI(pctClientes, pctTerminos, costoFijoManual);
            }

            function updateUI(pctClientes, pctTerminos, costoFijoManual) {
                document.getElementById("summary-kpi-dir").textContent =
                    solicitudesAyuda.length;
                document.getElementById("summary-kpi-sup").textContent =
                    `${pctTerminos.toFixed(1)}%`;
                document.getElementById("summary-kpi-admin").textContent =
                    `${(pctClientes * 100).toFixed(1)}%`;
                document.getElementById("summary-kpi-ventas").textContent =
                    nuevosAsuntos.length;
                document.getElementById("total-costos-fijos").textContent =
                    formatCurrency(costoFijoManual);
            }

            function renderModal(type, id) {
                const modalContent = document.getElementById("modal-content");
                let html = "";

                if (type === "equipo") {
                    const equipo = firma.equipos.find((e) => e.id === id);
                    const calc = currentCalculations.equipos[id];
                    const totalAsuntos = Object.values(equipo.casos).reduce(
                        (a, b) => a + b,
                        0,
                    );
                    const asuntosHTML = Object.entries(equipo.casos)
                        .map(
                            ([tipo, num]) =>
                                `<div class="flex justify-between text-sm"><p>${tipo}:</p><p class="font-medium">${num}</p></div>`,
                        )
                        .join("");
                    const miembrosHTML = equipo.miembros
                        .map(
                            (m) =>
                                `<div class="flex justify-between text-sm"><p>${m.nombre} (${m.rol})</p><p class="font-medium">${formatCurrency(calc.remuneraciones[m.nombre])}</p></div>`,
                        )
                        .join("");

                    html = `<h2 class="text-xl font-bold mb-4">${equipo.nombre}</h2>
                            <hr class="border-gray-700 my-4">
                            <h3 class="font-semibold mb-2 text-white">Remuneración Mensual</h3>
                            <div class="space-y-2">${miembrosHTML}</div>
                            <div class="flex justify-between font-bold text-base mt-2 border-t border-gray-700 pt-2"><span class="text-blue-400">Bono por Asuntos:</span><span class="text-blue-400">${formatCurrency(calc.bonoPorAsuntos)}</span></div>
                            <hr class="border-gray-700 my-4">
                            <h3 class="font-semibold mb-2 text-white">Cartera de Asuntos (${totalAsuntos})</h3>
                            <div class="space-y-1">${asuntosHTML}</div>
                            <div class="mt-6 flex flex-col gap-3"><button class="modal-trigger w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-type="solicitud" data-id="${id}">Solicitar Asesoría</button><button class="modal-close-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button></div>`;
                } else if (type === "area") {
                    const area = firma.personalFijo.find((a) => a.id === id);
                    if (area.id === "dir") {
                        const costosHTML = costosFijos
                            .map(
                                (costo, index) =>
                                    `<div class="flex items-center gap-2"><input type="text" value="${costo.nombre}" class="costo-nombre w-full bg-gray-700 border-gray-600 rounded-lg px-3 py-1 text-sm" data-index="${index}"><div class="relative"><span class="absolute inset-y-0 left-0 pl-2 flex items-center text-gray-500 text-sm">$</span><input type="number" value="${costo.monto}" class="costo-monto w-32 bg-gray-700 border-gray-600 rounded-lg pl-6 pr-2 py-1 text-sm" data-index="${index}"></div></div>`,
                            )
                            .join("");
                        html = `<div class="space-y-4 flex-1 overflow-y-auto"><h2 class="text-lg font-semibold text-white">Panel de Control</h2><div class="bg-gray-800/50 p-4 rounded-xl space-y-3"><h3 class="font-semibold text-white text-sm">Costos Fijos</h3><div id="costos-lista" class="space-y-2 mb-4">${costosHTML}</div>${costosFijos.length < 15 ? '<div class="flex gap-2"><input type="text" id="nuevo-costo-nombre" placeholder="Nombre del costo" class="w-full bg-gray-700 border-gray-600 rounded-lg px-3 py-1 text-sm"><div class="relative"><span class="absolute inset-y-0 left-0 pl-2 flex items-center text-gray-500 text-sm">$</span><input type="number" id="nuevo-costo-monto" placeholder="Monto" class="w-32 bg-gray-700 border-gray-600 rounded-lg pl-6 pr-2 py-1 text-sm"></div></div><button id="agregar-costo-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Agregar Costo</button>' : ""}</div><div class="bg-gray-800/50 p-4 rounded-xl space-y-3"><h3 class="font-semibold text-white text-sm">Clientes</h3><div><label for="total-clientes" class="block text-xs font-medium text-gray-400">Total con Vencimiento</label><input type="number" id="total-clientes" value="100" class="w-full bg-gray-700/50 border-gray-600 rounded-lg px-4 py-2 mt-1 text-sm"/></div><div><label for="clientes-pagando" class="block text-xs font-medium text-gray-400">Pagaron a Tiempo</label><input type="number" id="clientes-pagando" value="85" class="w-full bg-gray-700/50 border-gray-600 rounded-lg px-4 py-2 mt-1 text-sm"/></div></div><div class="bg-gray-800/50 p-4 rounded-xl space-y-3"><h3 class="font-semibold text-white text-sm">Cumplimiento</h3><div><label for="total-terminos" class="block text-xs font-medium text-gray-400">Total de Términos</label><input type="number" id="total-terminos" value="200" class="w-full bg-gray-700/50 border-gray-600 rounded-lg px-4 py-2 mt-1 text-sm"/></div><div><label for="terminos-cumplidos" class="block text-xs font-medium text-gray-400">Cumplidos a Tiempo</label><input type="number" id="terminos-cumplidos" value="190" class="w-full bg-gray-700/50 border-gray-600 rounded-lg px-4 py-2 mt-1 text-sm"/></div></div></div><div class="mt-6 flex flex-col gap-3"><button id="guardar-costos-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar y Cerrar</button></div>`;
                    } else {
                        const estatus = document.getElementById(
                            `summary-kpi-${id}`,
                        ).textContent;
                        let contentHTML =
                            area.id === "ventas"
                                ? `<hr class="border-gray-700"><div class="mt-4"><button class="modal-trigger w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-type="nuevoAsunto" data-id="0">Registrar Nuevo Asunto</button></div>`
                                : "";
                        html = `<h2 class="text-xl font-bold mb-4">${area.rol}</h2><div class="space-y-4"><div><p class="kpi-label">Objetivo</p><p class="text-lg font-medium text-white">${area.kpiLabel}</p></div><div><p class="kpi-label">Estatus Actual</p><p class="text-2xl font-bold text-emerald-400">${estatus}</p></div><hr class="border-gray-700"><div><p class="kpi-label">Incentivo Calculado</p><p class="text-2xl font-bold text-blue-400">${formatCurrency(currentCalculations.areas[id].incentivo)}</p></div>${contentHTML}</div><div class="mt-6"><button class="modal-close-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button></div>`;
                    }
                }
                modalContent.innerHTML = html;
                toggleModal(true);
            }

            function toggleModal(show) {
                const container = document.getElementById("modal-container");
                const panel = document.getElementById("modal-panel");
                const backdrop = document.getElementById("modal-backdrop");
                if (show) {
                    container.classList.remove("hidden");
                    setTimeout(() => {
                        backdrop.classList.remove("opacity-0");
                        panel.classList.remove("opacity-0", "scale-95");
                    }, 10);
                } else {
                    backdrop.classList.add("opacity-0");
                    panel.classList.add("opacity-0", "scale-95");
                    setTimeout(() => container.classList.add("hidden"), 300);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                const equiposContainer =
                    document.getElementById("equipos-container");
                firma.equipos.forEach((unidad) => {
                    equiposContainer.innerHTML += crearEquipoCardHTML(unidad);
                });

                const areasContainer = document.getElementById(
                    "areas-fijas-container",
                );
                firma.personalFijo.forEach((area) => {
                    areasContainer.innerHTML += crearAreaCardHTML(area);
                });

                document.body.addEventListener("click", (e) => {
                    const trigger = e.target.closest(".modal-trigger");
                    if (trigger) {
                        renderModal(trigger.dataset.type, trigger.dataset.id);
                    }

                    if (
                        e.target.closest(".modal-close-btn") ||
                        e.target.id === "modal-backdrop"
                    ) {
                        toggleModal(false);
                    }

                    if (e.target.id === "guardar-costos-btn") {
                        const nombres =
                            document.querySelectorAll(".costo-nombre");
                        const montos =
                            document.querySelectorAll(".costo-monto");
                        costosFijos = Array.from(nombres).map((_, i) => ({
                            nombre: nombres[i].value,
                            monto: parseFloat(montos[i].value) || 0,
                        }));
                        calcularTodo();
                        toggleModal(false);
                    }

                    const modalPanel = document.getElementById("modal-panel");
                    if (modalPanel && e.target.closest("input")) {
                        modalPanel.addEventListener("input", calcularTodo);
                    }
                });

                calcularTodo();
            });
        </script>
    </body>
</html>
